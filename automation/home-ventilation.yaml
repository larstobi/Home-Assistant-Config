- id: '27'
  alias: 'Ventilation up on'
  trigger:
  - entity_id: sensor.family_bathroom_multisensor_relative_humidity, sensor.master_bathroom_multisensor_relative_humidity, sensor.laundry_multisensor_relative_humidity
    platform: state
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: '{{ states.sensor.divergence_humidity.state|float > 2 }}'
      - condition: state
        entity_id: light.house_ventilation_dimmer_level
        state: 'on'
  action:
    - service: light.turn_on
      entity_id: light.house_ventilation_dimmer_level
      data_template:
        brightness: >
          {% set divergence = states.sensor.divergence_humidity.state|float %}
          {% set speed = states.light.house_ventilation_dimmer_level.attributes.brightness %}
          {% if divergence > 9 %}
            255
          {% elif divergence > 6 and speed > 200  %}
            255
          {% elif divergence > 4 %}
            118
          {% elif divergence > 2 and speed > 100 %}
            118
          {% endif %}

- id: '32'
  alias: 'Ventilation up off'
  trigger:
  - entity_id: sensor.family_bathroom_multisensor_relative_humidity, sensor.master_bathroom_multisensor_relative_humidity, sensor.laundry_multisensor_relative_humidity
    platform: state
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: '{{ states.sensor.divergence_humidity.state|float > 3 }}'
      - condition: state
        entity_id: light.house_ventilation_dimmer_level
        state: 'off'
  action:
    - service: light.turn_on
      entity_id: light.house_ventilation_dimmer_level
      data_template:
        brightness: >
          {% set divergence = states.sensor.divergence_humidity.state|float %}
          {% if divergence > 9 %}
            255
          {% elif divergence > 4 %}
            118
          {% endif %}

- id: '33'
  alias: 'Ventilation off'
  trigger:
  - entity_id: sensor.family_bathroom_multisensor_relative_humidity, sensor.master_bathroom_multisensor_relative_humidity, sensor.laundry_multisensor_relative_humidity
    platform: state
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: '{{ states.sensor.divergence_humidity.state|float < 2 }}'
      - condition: state
        entity_id: light.house_ventilation_dimmer_level
        state: 'on'
  action:
    - service: light.turn_off
      entity_id: light.house_ventilation_dimmer_level
